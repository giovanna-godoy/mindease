<div class="p-4 md:p-6 space-y-4 md:space-y-6 max-w-7xl mx-auto">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
    <div>
      <h1 class="flex items-center gap-2 text-xl md:text-2xl font-bold">
        <mat-icon class="material-icons-rounded" [style.color]="'var(--primary)'">dashboard_customize</mat-icon>
        Organizador de Tarefas
      </h1>
      <p class="text-muted-foreground mt-1 text-sm md:text-base" [style.color]="'var(--muted-foreground)'">
        Gerencie suas tarefas de forma simples e visual
      </p>
    </div>
    <div class="flex gap-2">
      <button (click)="openNewTaskDialog()"
        class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium w-full sm:w-auto"
        [style.backgroundColor]="'var(--primary)'" [style.color]="'var(--primary-foreground)'">
        <mat-icon class="material-icons-rounded">add</mat-icon>
        Nova Tarefa
      </button>
      <button (click)="refreshTasks()" class="flex items-center gap-2 px-4 py-2 rounded-lg font-medium border"
        [style.borderColor]="'var(--border)'" [style.color]="'var(--card-foreground)'" title="Atualizar tarefas">
        <mat-icon class="material-icons-rounded">refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- A Fazer -->
    <div class="rounded-lg p-4" [style.backgroundColor]="'var(--card)'" [style.borderColor]="'var(--border)'"
      style="border: 1px solid">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full" [style.backgroundColor]="'#9CA3AF'"></div>
          <h2 class="font-semibold">A Fazer <span class="text-xs text-muted-foreground ml-1">({{
              getTaskCountByStatus('todo') }})</span></h2>
        </div>
        <button (click)="openNewTaskDialog('todo')" class="text-muted-foreground hover:text-foreground">
          <mat-icon class="material-icons-rounded text-lg">add</mat-icon>
        </button>
      </div>
      <div class="space-y-3">
        <div *ngFor="let task of tasks | filter:'todo'" class="p-4 rounded-xl cursor-pointer"
          [style.backgroundColor]="'#F8F9FA'" (click)="openEditTaskDialog(task)">
          <div class="flex items-start justify-between mb-2">
            <h3 class="font-semibold text-base">{{ task.title }}</h3>
            <button (click)="deleteTask(task, $event)" class="text-red-400 hover:text-red-500 flex-shrink-0"
              title="Excluir tarefa">
              <mat-icon class="material-icons-rounded text-lg">delete</mat-icon>
            </button>
          </div>

          <p class="complexity-medium text-sm mb-3" [style.color]="'#6B7280'">{{ task.description }}</p>

          <div *ngIf="addingSubtaskFor === task.id" class="mb-3 flex items-center gap-2"
            (click)="$event.stopPropagation()">

            <input type="text" [(ngModel)]="newSubtaskTitle" placeholder="Nova subtarefa..."
              class="flex-1 px-3 py-2 rounded-lg text-sm" [style.backgroundColor]="'white'"
              [style.border]="'1px solid #D1D5DB'" (keyup.enter)="addSubtask(task)"
              (keyup.escape)="cancelAddSubtask()" />

            <button type="button" (click)="addSubtask(task); $event.stopPropagation()"
              class="flex-shrink-0 flex items-center justify-center px-3 py-2 rounded-lg"
              [style.backgroundColor]="'var(--primary)'" [style.color]="'white'">
              <mat-icon class="material-icons-rounded" style="font-size: 18px;">
                check
              </mat-icon>
            </button>

          </div>
          <button *ngIf="addingSubtaskFor !== task.id" (click)="showAddSubtask(task.id); $event.stopPropagation()"
            class="complexity-complete text-sm mb-3 inline-flex items-center gap-1.5" [style.color]="'#8B5CF6'">
            <mat-icon class="material-icons-rounded align-middle"
              style="font-size: 16px; width: 16px; height: 16px;">add_circle_outline</mat-icon>
            Adicionar subtarefa
          </button>

          <div class="complexity-complete flex flex-wrap gap-8 mb-4" (click)="$event.stopPropagation()">
            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="getPriorityColor(task.priority)" [style.color]="'white'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">label</mat-icon>
              {{ task.priority === 'low' ? 'Baixa' : task.priority === 'medium' ? 'Média' : 'Alta' }}
            </span>
            <span *ngIf="task.subtasks?.length"
              class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">check_circle</mat-icon>
              {{ getCompletedSubtasks(task) }}/{{ getTotalSubtasks(task) }}
            </span>
            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">schedule</mat-icon>
              {{ task.estimatedTime }}min
            </span>
          </div>

          <div class="flex gap-2" (click)="$event.stopPropagation()">
            <button (click)="toggleTaskStatus(task); $event.stopPropagation()"
              class="inline-flex px-3 py-2 rounded-lg text-sm font-medium items-center justify-center gap-1.5"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 16px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">arrow_forward</mat-icon>
              Em Progresso
            </button>
            <button (click)="toggleTaskStatus(task); $event.stopPropagation()"
              class="inline-flex px-3 py-2 rounded-lg text-sm font-medium items-center justify-center gap-1.5"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 16px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">arrow_forward</mat-icon>
              Concluído
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Em Progresso -->
    <div class="rounded-lg p-4" [style.backgroundColor]="'var(--card)'" [style.borderColor]="'var(--border)'"
      style="border: 1px solid">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full" [style.backgroundColor]="'#3B82F6'"></div>
          <h2 class="font-semibold">Em Progresso <span class="text-xs text-muted-foreground ml-1">({{
              getTaskCountByStatus('in_progress') }})</span></h2>
        </div>
        <button (click)="openNewTaskDialog('in_progress')" class="text-muted-foreground hover:text-foreground">
          <mat-icon class="material-icons-rounded text-lg">add</mat-icon>
        </button>
      </div>
      <div class="space-y-3">
        <div *ngFor="let task of tasks | filter:'in_progress'" class="p-4 rounded-xl cursor-pointer"
          [style.backgroundColor]="'#F8F9FA'" (click)="openEditTaskDialog(task)">
          <div class="flex items-start justify-between mb-2">
            <h3 class="font-semibold text-base">{{ task.title }}</h3>
            <button (click)="deleteTask(task, $event)" class="text-red-400 hover:text-red-500 flex-shrink-0"
              title="Excluir tarefa">
              <mat-icon class="material-icons-rounded text-lg">delete</mat-icon>
            </button>
          </div>

          <p class="complexity-medium text-sm mb-3" [style.color]="'#6B7280'">{{ task.description }}</p>

          <div *ngIf="addingSubtaskFor === task.id" class="complexity-complete mb-3 flex flex-row items-center gap-2"
            (click)="$event.stopPropagation()">
            <input type="text" [(ngModel)]="newSubtaskTitle" placeholder="Nova subtarefa..."
              class="flex-1 px-3 py-2 rounded-lg text-sm" [style.backgroundColor]="'white'"
              [style.border]="'1px solid #D1D5DB'" (keyup.enter)="addSubtask(task)"
              (keyup.escape)="cancelAddSubtask()" />
            <button (click)="addSubtask(task); $event.stopPropagation()"
              class="flex items-center justify-center px-3 py-2 rounded-lg" [style.backgroundColor]="'var(--primary)'"
              [style.color]="'white'">
              <mat-icon class="material-icons-rounded" style="font-size: 18px;">check</mat-icon>
            </button>
          </div>

          <button *ngIf="addingSubtaskFor !== task.id" (click)="showAddSubtask(task.id); $event.stopPropagation()"
            class="complexity-complete text-sm mb-3 inline-flex items-center gap-1.5" [style.color]="'#8B5CF6'">
            <mat-icon class="material-icons-rounded align-middle"
              style="font-size: 16px; width: 16px; height: 16px;">add_circle_outline</mat-icon>
            Adicionar subtarefa
          </button>

          <div class="complexity-complete flex flex-wrap gap-8 mb-4" (click)="$event.stopPropagation()">
            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="getPriorityColor(task.priority)" [style.color]="'white'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">label</mat-icon>
              {{ task.priority === 'low' ? 'Baixa' : task.priority === 'medium' ? 'Média' : 'Alta' }}
            </span>
            <span *ngIf="task.subtasks?.length"
              class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">check_circle</mat-icon>
              {{ getCompletedSubtasks(task) }}/{{ getTotalSubtasks(task) }}
            </span>
            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">schedule</mat-icon>
              {{ task.estimatedTime }}min
            </span>
          </div>

          <div class="flex gap-2" (click)="$event.stopPropagation()">
            <button (click)="toggleTaskStatus(task); $event.stopPropagation()"
              class="inline-flex px-3 py-2 rounded-lg text-sm font-medium items-center justify-center gap-1.5"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 16px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;">arrow_forward</mat-icon>
              Concluído
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Concluído -->
    <div class="rounded-lg p-4" [style.backgroundColor]="'var(--card)'" [style.borderColor]="'var(--border)'"
      style="border: 1px solid">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 rounded-full" [style.backgroundColor]="'var(--accent)'"></div>
          <h2 class="font-semibold">Concluído <span class="text-xs text-muted-foreground ml-1">({{
              getTaskCountByStatus('done') }})</span></h2>
        </div>
        <button (click)="openNewTaskDialog('done')" class="text-muted-foreground hover:text-foreground">
          <mat-icon class="material-icons-rounded text-lg">add</mat-icon>
        </button>
      </div>
      <div class="space-y-3">
        <div *ngFor="let task of tasks | filter:'done'" class="p-4 rounded-xl cursor-pointer"
          [style.backgroundColor]="'#F8F9FA'" (click)="openEditTaskDialog(task)">
          <div class="flex items-start justify-between mb-2">
            <h3 class="font-semibold text-base">{{ task.title }}</h3>
            <button (click)="deleteTask(task, $event)" class="text-red-400 hover:text-red-500 flex-shrink-0"
              title="Excluir tarefa">
              <mat-icon class="material-icons-rounded text-lg">delete</mat-icon>
            </button>
          </div>

          <p class="complexity-medium text-sm mb-3" [style.color]="'#6B7280'">{{ task.description }}</p>

          <div class="complexity-complete flex flex-wrap gap-8 mb-4" (click)="$event.stopPropagation()">
            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="getPriorityColor(task.priority)" [style.color]="'white'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">label</mat-icon>
              {{ task.priority === 'low' ? 'Baixa' : task.priority === 'medium' ? 'Média' : 'Alta' }}
            </span>
            <span *ngIf="task.subtasks?.length"
              class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="'#D1FAE5'" [style.color]="'#059669'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">check_circle</mat-icon>
              {{ getTotalSubtasks(task) }}/{{ getTotalSubtasks(task) }}
            </span>
            <span class="inline-flex px-2.5 py-1 rounded-full text-xs font-medium items-center gap-2"
              [style.backgroundColor]="'#E9D5FF'" [style.color]="'#7C3AED'">
              <mat-icon class="material-icons-rounded"
                style="font-size: 14px; width: 14px; height: 14px;">schedule</mat-icon>
              {{ task.estimatedTime }}min
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div *ngIf="deletingTaskId" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
    <div class="w-16 h-16 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
    <p class="text-lg font-medium text-gray-700">Excluindo tarefa...</p>
  </div>
</div>

<!-- Task Form Dialog -->
<app-task-form-dialog [isOpen]="isDialogOpen" [task]="dialogTask" [defaultStatus]="dialogDefaultStatus"
  (openChange)="onDialogOpenChange($event)" (taskSubmit)="onTaskSubmit($event)"></app-task-form-dialog>